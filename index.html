<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kick Shuffler Prototype</title>
    <style>
        body { background: #121212; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        #status { color: #00ffcc; margin-bottom: 20px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; }
        .icon-container { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        #voice-icon { width: 80px; height: 80px; border: 3px solid #00ffcc; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 15px #00ffcc; cursor: pointer; background: rgba(0, 255, 204, 0.1); transition: all 0.3s; }
        #voice-icon:hover { background: rgba(0, 255, 204, 0.3); transform: scale(1.05); }
        #voice-icon.active { background: rgba(0, 255, 204, 0.3); box-shadow: 0 0 25px #00ffcc; }
        #drum-icon { width: 200px; height: 200px; border: 4px solid #ff00ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px #ff00ff; transition: transform 0.1s; cursor: pointer; }
        #drum-icon.pulse { transform: scale(1.1); background: rgba(255, 0, 255, 0.2); }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); background: rgba(255, 0, 255, 0.2); }
            100% { transform: scale(1); }
        }
        #drum-icon.pulsing { animation: pulse 0.1s ease-out; }
        h1 { margin-top: 30px; font-size: 1.2rem; color: #aaa; }
        .controls { margin-top: 40px; display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        button { background: transparent; border: 1px solid #fff; color: #fff; padding: 10px 20px; border-radius: 20px; cursor: pointer; }
        button:hover { background: #fff; color: #000; }
        .tempo-control { margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .tempo-control input { width: 200px; }
        .tempo-control label { color: #aaa; font-size: 0.9rem; }
        #tempo-display { color: #00ffcc; font-weight: bold; font-size: 1.2rem; }
        button.active { background: #00ffcc; color: #000; border-color: #00ffcc; }
        .instructions-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid #666; color: #aaa; padding: 5px 15px; font-size: 0.8rem; border-radius: 15px; cursor: pointer; margin-top: 10px; }
        .instructions-btn:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }
    </style>
</head>
<body>

    <div id="status">Voice Standby</div>
    
    <div class="icon-container">
        <div id="voice-icon" onclick="toggleVoice()">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#00ffcc" stroke-width="2">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        </div>
        <div id="drum-icon" onclick="playCurrentKick()">
            <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="#ff00ff" stroke-width="1.5">
                <ellipse cx="12" cy="9" rx="10" ry="5"></ellipse>
                <path d="M2 9v6c0 2.5 4.5 5 10 5s10-2.5 10-5V9"></path>
                <path d="M7 12.5v3M12 14v3M17 12.5v3"></path>
            </svg>
        </div>
    </div>

    <h1 id="filename">READY TO SHUFFLE</h1>

    <button class="instructions-btn" onclick="showVoiceInstructions()">Voice Commands</button>

    <div class="controls">
        <button id="loop-btn" onclick="toggleLoop()">Start Loop</button>
        <button onclick="shuffleKick()">Shuffle Kick</button>
        <button onclick="downloadKick()">Download Kick</button>
        <button onclick="sendEmail()">Email This Kick</button>
    </div>

    <div class="tempo-control">
        <label for="tempo-slider">Tempo (BPM)</label>
        <div id="tempo-display">120</div>
        <input type="range" id="tempo-slider" min="60" max="200" value="120" oninput="setTempo(this.value)">
    </div>

    <script>
        // 1. Define your library (Make sure these filenames match your folder)
const kickLibrary = [
    "StudioBrootle House Kicks-01.wav",
    "StudioBrootle House Kicks-02.wav",
    "StudioBrootle House Kicks-03.wav",
    "StudioBrootle House Kicks-04.wav",
    "StudioBrootle House Kicks-05.wav",
    "StudioBrootle House Kicks-06.wav",
    "StudioBrootle House Kicks-07.wav",
    "StudioBrootle House Kicks-08.wav",
    "StudioBrootle House Kicks-09.wav",
    "StudioBrootle House Kicks-10.wav",
    "StudioBrootle House Kicks-11.wav",
    "StudioBrootle House Kicks-12.wav",
    "StudioBrootle House Kicks-13.wav",
    "StudioBrootle House Kicks-14.wav",
    "StudioBrootle House Kicks-15.wav",
    "StudioBrootle House Kicks-16.wav",
    "StudioBrootle House Kicks-17.wav",
    "StudioBrootle House Kicks-18.wav",
    "StudioBrootle House Kicks-19.wav",
    "StudioBrootle House Kicks-20.wav"
];

let currentKick = "";
let isLooping = false;
let loopInterval = null;
let bpm = 120;
let recognition = null;
let isVoiceActive = false;
let audioPlayer = new Audio(); // Reuse single audio object
audioPlayer.preload = 'auto';
let lastBeatTime = 0;
let beatDrift = 0;

function shuffleKick() {
    const drum = document.getElementById('drum-icon');
    const fileText = document.getElementById('filename');
    
    // Select random file
    currentKick = kickLibrary[Math.floor(Math.random() * kickLibrary.length)];
    fileText.innerText = currentKick.toUpperCase();

    // Play the actual audio file
    const audio = new Audio(currentKick);
    audio.play().catch(err => {
        console.error('Audio playback failed:', err);
        document.getElementById('status').innerText = 'Tap to play';
    });

    // Visual pulse using CSS animation
    drum.classList.remove('pulsing');
    void drum.offsetWidth; // Force reflow
    drum.classList.add('pulsing');
}

function playCurrentKick() {
    if (!currentKick) {
        shuffleKick();
        return;
    }
    
    const drum = document.getElementById('drum-icon');
    const audio = new Audio(currentKick);
    audio.play().catch(err => {
        console.error('Audio playback failed:', err);
        document.getElementById('status').innerText = 'Tap to play';
    });
    
    // Visual pulse using CSS animation
    drum.classList.remove('pulsing');
    void drum.offsetWidth; // Force reflow
    drum.classList.add('pulsing');
}

function toggleLoop() {
    const btn = document.getElementById('loop-btn');
    const status = document.getElementById('status');
    
    if (isLooping) {
        // Stop loop
        isLooping = false;
        clearInterval(loopInterval);
        btn.innerText = 'Start Loop';
        btn.classList.remove('active');
        status.innerText = 'Loop Stopped';
    } else {
        // Start loop with drift compensation
        isLooping = true;
        lastBeatTime = Date.now();
        beatDrift = 0;
        
        playCurrentKick();
        
        const intervalTime = (60 / bpm) * 1000;
        
        loopInterval = setInterval(() => {
            const now = Date.now();
            const expectedTime = lastBeatTime + intervalTime;
            beatDrift = now - expectedTime;
            
            playCurrentKick();
            lastBeatTime = expectedTime; // Use expected time to prevent drift
        }, intervalTime);
        
        btn.innerText = 'Stop Loop';
        btn.classList.add('active');
        status.innerText = 'Looping at ' + bpm + ' BPM';
    }
}

function setTempo(value) {
    bpm = parseInt(value);
    document.getElementById('tempo-display').innerText = bpm;
    
    // If currently looping, restart with new tempo and reset drift
    if (isLooping) {
        clearInterval(loopInterval);
        lastBeatTime = Date.now();
        beatDrift = 0;
        
        const intervalTime = (60 / bpm) * 1000;
        
        loopInterval = setInterval(() => {
            const now = Date.now();
            const expectedTime = lastBeatTime + intervalTime;
            beatDrift = now - expectedTime;
            
            playCurrentKick();
            lastBeatTime = expectedTime;
        }, intervalTime);
        
        document.getElementById('status').innerText = 'Looping at ' + bpm + ' BPM';
    }
}

function showVoiceInstructions() {
    alert('Voice Commands:\n\n' +
        '• "Shuffle" or "Next" or "New kick" - Get a new kick sample\n' +
        '• "Play" or "Replay" or "Again" - Play current kick\n' +
        '• "Start loop" or "Loop" - Start looping\n' +
        '• "Stop loop" or "Stop looping" - Stop looping\n' +
        '• "Download" or "Save file" - Download current kick\n' +
        '• "Email" or "Send" - Email current kick\n' +
        '• "Tempo [number]" or "BPM [number]" - Set tempo (60-200)\n\n' +
        'Click the microphone button to start/stop voice control.');
}

function downloadKick() {
    if (!currentKick) {
        alert('Please shuffle a kick first!');
        return;
    }
    
    // Create a temporary link to download the audio file
    const link = document.createElement('a');
    link.href = currentKick;
    link.download = currentKick;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    const status = document.getElementById('status');
    status.innerText = 'Download Started';
    setTimeout(() => {
        if (!isLooping) status.innerText = isVoiceActive ? 'Listening...' : 'Voice Standby';
    }, 2000);
}

function sendEmail() {
    if (!currentKick) {
        alert('Please shuffle a kick first!');
        return;
    }
    
    // Ask for user's email
    const userEmail = prompt('Enter your email address:');
    
    if (!userEmail || !userEmail.includes('@')) {
        alert('Please enter a valid email address.');
        return;
    }
    
    const subject = encodeURIComponent('Kick Sample: ' + currentKick);
    const body = encodeURIComponent(
        `Hey!\n\nI found this awesome kick sample:\n\n${currentKick}\n\nFrom the Studio Brootle House Kick Sample Pack.\n\nLet me know what you think!`
    );
    
    // Create mailto link to user's own email
    window.location.href = `mailto:${userEmail}?subject=${subject}&body=${body}`;
    
    const status = document.getElementById('status');
    status.innerText = 'Opening email...';
    
    setTimeout(() => {
        if (!isLooping) status.innerText = isVoiceActive ? 'Listening...' : 'Voice Standby';
    }, 2000);
}

function toggleVoice() {
    const icon = document.getElementById('voice-icon');
    const status = document.getElementById('status');
    
    if (isVoiceActive) {
        // Stop voice recognition
        if (recognition) {
            recognition.stop();
        }
        isVoiceActive = false;
        icon.classList.remove('active');
        status.innerText = 'Voice Stopped';
    } else {
        // Check for microphone permissions first
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function(stream) {
                    // Permission granted, stop the stream and start speech recognition
                    stream.getTracks().forEach(track => track.stop());
                    startVoiceRecognition(icon, status);
                })
                .catch(function(err) {
                    alert('Microphone permission denied. Please allow microphone access in your browser settings and try again.');
                    console.error('Microphone permission error:', err);
                });
        } else {
            // Fallback for older browsers
            startVoiceRecognition(icon, status);
        }
    }
}

function startVoiceRecognition(icon, status) {
    // Start voice recognition
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('Voice recognition not supported in this browser. Please use Chrome or Edge.');
        return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.lang = 'en-US';
    
    recognition.onstart = function() {
        isVoiceActive = true;
        icon.classList.add('active');
        status.innerText = 'Listening...';
    };
    
    recognition.onresult = function(event) {
        const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
        status.innerText = 'Heard: ' + transcript;
        
        // Voice commands
        if (transcript.includes('shuffle') || transcript.includes('next') || transcript.includes('new kick')) {
            shuffleKick();
        } else if (transcript.includes('play') || transcript.includes('replay') || transcript.includes('again')) {
            playCurrentKick();
        } else if (transcript.includes('start loop') || transcript.includes('loop')) {
            if (!isLooping) toggleLoop();
        } else if (transcript.includes('stop loop') || transcript.includes('stop looping')) {
            if (isLooping) toggleLoop();
        } else if (transcript.includes('download') || transcript.includes('save file')) {
            downloadKick();
        } else if (transcript.includes('email') || transcript.includes('send')) {
            sendEmail();
        } else if (transcript.includes('tempo') || transcript.includes('speed') || transcript.includes('bpm')) {
            // Extract number from command
            const numbers = transcript.match(/\d+/);
            if (numbers) {
                const newBpm = parseInt(numbers[0]);
                if (newBpm >= 60 && newBpm <= 200) {
                    document.getElementById('tempo-slider').value = newBpm;
                    setTempo(newBpm);
                }
            }
        }
        
        setTimeout(() => {
            if (isVoiceActive && !isLooping) status.innerText = 'Listening...';
        }, 2000);
    };
    
    recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        status.innerText = 'Error: ' + event.error;
        setTimeout(() => {
            if (isVoiceActive) status.innerText = 'Listening...';
        }, 2000);
    };
    
    recognition.onend = function() {
        if (isVoiceActive) {
            recognition.start(); // Restart if still active
        }
    };
    
    recognition.start();
}

// Initialize with random kick on page load
window.onload = function() {
    const fileText = document.getElementById('filename');
    currentKick = kickLibrary[Math.floor(Math.random() * kickLibrary.length)];
    fileText.innerText = currentKick.toUpperCase();
};
    </script>
</body>
</html>